// 中国滑雪积分系统 - 核心成绩数据库
// SQLite 数据库 - 存储所有运动员、比赛、成绩数据

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./ski.db"
}

// ========== 运动员表 ==========
model Athlete {
  id        String   @id @default(cuid())
  name      String                    // 姓名
  team      String                    // 单位
  gender    String                    // 性别：男/女
  birthYear String?                   // 出生年份
  idNumber  String?                   // 身份证号（可选）
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  results      Result[]
  seasonTotals SeasonTotal[]

  @@unique([name, team])              // 姓名+单位唯一
  @@index([name])
}

// ========== 比赛表 ==========
model Competition {
  id        String   @id @default(cuid())
  name      String                    // 比赛名称
  sportType String                    // snowboard-parallel/freestyle-slopestyle等
  sport     String                    // 中文项目名：单板平行项目/自由式坡面障碍技巧等
  location  String                    // 比赛地点
  date      String                    // 开始日期
  endDate   String                    // 结束日期
  status    String   @default("completed")
  pdfSource String?                   // PDF来源文件名
  createdAt DateTime @default(now())

  results   Result[]

  @@index([sportType])
  @@index([date])
}

// ========== 成绩表（核心） ==========
model Result {
  id            String      @id @default(cuid())

  athleteId     String
  athlete       Athlete     @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  competitionId String
  competition   Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)

  discipline    String      // 小项：平行大回转/大跳台/坡面障碍技巧
  ageGroup      String      // U11/U15/U18
  gender        String      // 男子组/女子组

  rank          Int         // 最终排名
  bib           Int         // 号码布
  run1          String?     // 第一轮成绩
  run2          String?     // 第二轮成绩
  time          String?     // 总时间
  diff          String?     // 与冠军差值
  bestScore     Float?      // 最佳得分（技巧类）
  points        Int         // 获得积分

  createdAt     DateTime    @default(now())

  @@unique([athleteId, competitionId, discipline, ageGroup, gender])
  @@index([competitionId])
  @@index([ageGroup, gender])
  @@index([discipline])
}

// ========== 赛季积分汇总表 ==========
model SeasonTotal {
  id               String   @id @default(cuid())

  athleteId        String
  athlete          Athlete  @relation(fields: [athleteId], references: [id], onDelete: Cascade)

  season           String   // 2024-2025
  ageGroup         String   // U11/U15/U18
  gender           String   // 男子组/女子组

  totalPoints      Int      @default(0)   // 总积分
  competitionCount Int      @default(0)   // 参赛次数
  avgPoints        Float    @default(0)   // 平均积分
  bestRank         Int?                   // 最佳名次
  rank             Int?                   // 总排名

  updatedAt        DateTime @updatedAt

  @@unique([athleteId, season, ageGroup, gender])
  @@index([season, ageGroup, gender])
}

// ========== 导入日志表 ==========
model ImportLog {
  id           String    @id @default(cuid())
  filename     String                  // PDF文件名
  status       String                  // pending/processing/completed/failed
  totalRows    Int       @default(0)
  importedRows Int       @default(0)
  errorMessage String?
  createdAt    DateTime  @default(now())
  completedAt  DateTime?
}

// ========== 运动员合并记录表 ==========
// 用于记录运动员换单位后的合并历史
model AthleteAlias {
  id               String   @id @default(cuid())
  primaryAthleteId String                  // 主运动员ID（保留的）
  oldName          String                  // 合并前的姓名
  oldTeam          String                  // 合并前的单位
  mergedAt         DateTime @default(now()) // 合并时间
  mergedBy         String                  // 操作人

  @@index([primaryAthleteId])
}

// ========== 合作意向表 ==========
// 存储合作咨询页面提交的合作意向
model CooperationInquiry {
  id              String   @id @default(cuid())
  name            String                  // 联系人姓名
  company         String                  // 公司/机构名称
  email           String                  // 电子邮箱
  phone           String                  // 联系电话
  cooperationType String                  // 合作类型：sponsor/venue/training/media/technology/other
  message         String                  // 合作意向说明
  status          String   @default("pending") // pending/contacted/completed/rejected
  notes           String?                 // 后台备注
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}
