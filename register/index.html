<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>æ³¨å†Œï½œä¸­å›½æ»‘é›ªç§¯åˆ†ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="æ³¨å†Œä¸­å›½æ»‘é›ªç§¯åˆ†ç³»ç»Ÿè´¦æˆ·ï¼Œäº«å—ä¸“ä¸šçš„ç§¯åˆ†æŸ¥è¯¢ã€èµ›äº‹æŠ¥åã€æˆç»©ç®¡ç†ç­‰å…¨æ–¹ä½æœåŠ¡ï¼Œæ”¯æŒé«˜å±±æ»‘é›ªã€è‡ªç”±å¼æ»‘é›ªã€å•æ¿æ»‘é›ªå¤šé¡¹ç›®ç§¯åˆ†ç®¡ç†ã€‚" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex flex-col">
  <!-- é¡¶éƒ¨å¯¼èˆªï¼ˆå ä½ï¼‰ -->
  <div id="site-nav"></div>

  <main id="main" class="flex-1">
    <section class="mx-auto max-w-6xl px-4 py-10">
      <!-- å”¯ä¸€ H1 -->
      <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">æ³¨å†Œ</h1>
      <p class="mt-2 text-gray-600 max-w-3xl">åˆ›å»ºæ–°è´¦æˆ·ï¼Œäº«å—ä¸“ä¸šç§¯åˆ†ç®¡ç†æœåŠ¡</p>

      <!-- é¡µé¢ä¸»ä½“ï¼šå¼ºåŒ–äº¤äº’ -->
      <div class="mt-8">
        <form id="register-form" class="max-w-md space-y-4" onsubmit="return handleRegister(event)">
          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">ç”¨æˆ·å</label>
            <input
              id="username"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              placeholder="å¦‚ï¼šsnowpro"
              required
              minlength="3"
              maxlength="20"
              onblur="checkUsername()"
              oninput="validateUsername()"
            />
            <div id="username-loading" class="text-sm mt-1 text-gray-500 hidden">
              <span class="inline-block animate-spin mr-2">â³</span>æ£€æŸ¥ç”¨æˆ·åå¯ç”¨æ€§...
            </div>
            <p id="name-msg" class="text-sm mt-1"></p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">é‚®ç®±åœ°å€</label>
            <input
              type="email"
              id="email"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
              placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€"
              required
              oninput="validateEmail()"
            />
            <div id="email-error" class="text-sm text-red-600 mt-1 hidden">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">å¯†ç </label>
            <div class="relative">
              <input
                type="password"
                id="pw"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                placeholder="è¯·è¾“å…¥å¯†ç "
                required
                minlength="8"
                oninput="validatePassword()"
              />
              <button
                type="button"
                onclick="togglePasswordVisibility('pw', 'eye-icon-1')"
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
              >
                <span id="eye-icon-1">ğŸ‘ï¸</span>
              </button>
            </div>

            <!-- å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨ -->
            <div class="mt-2">
              <div class="flex space-x-1">
                <div id="strength-1" class="h-2 w-1/4 bg-gray-200 rounded"></div>
                <div id="strength-2" class="h-2 w-1/4 bg-gray-200 rounded"></div>
                <div id="strength-3" class="h-2 w-1/4 bg-gray-200 rounded"></div>
                <div id="strength-4" class="h-2 w-1/4 bg-gray-200 rounded"></div>
              </div>
              <div id="password-requirements" class="text-xs text-gray-500 mt-1 space-y-1">
                <div id="req-length" class="flex items-center">
                  <span class="mr-2">âŒ</span>è‡³å°‘8ä¸ªå­—ç¬¦
                </div>
                <div id="req-lowercase" class="flex items-center">
                  <span class="mr-2">âŒ</span>åŒ…å«å°å†™å­—æ¯
                </div>
                <div id="req-uppercase" class="flex items-center">
                  <span class="mr-2">âŒ</span>åŒ…å«å¤§å†™å­—æ¯
                </div>
                <div id="req-number" class="flex items-center">
                  <span class="mr-2">âŒ</span>åŒ…å«æ•°å­—
                </div>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1 text-gray-700">ç¡®è®¤å¯†ç </label>
            <div class="relative">
              <input
                type="password"
                id="pw2"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
                required
                oninput="validatePasswordMatch()"
              />
              <button
                type="button"
                onclick="togglePasswordVisibility('pw2', 'eye-icon-2')"
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
              >
                <span id="eye-icon-2">ğŸ‘ï¸</span>
              </button>
            </div>
            <div id="password-match-error" class="text-sm text-red-600 mt-1 hidden">ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´</div>
            <div id="password-match-success" class="text-sm text-green-600 mt-1 hidden">å¯†ç ç¡®è®¤æˆåŠŸ</div>
          </div>

          <label class="flex items-start gap-2 text-sm select-none cursor-pointer">
            <input type="checkbox" id="agree" class="mt-0.5 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
            <span>
              æˆ‘å·²é˜…è¯»å¹¶åŒæ„
              <a class="text-blue-600 hover:text-blue-800 hover:underline transition-colors" href="/ski/terms/" target="_blank">æœåŠ¡æ¡æ¬¾</a>
              ä¸
              <a class="text-blue-600 hover:text-blue-800 hover:underline transition-colors" href="/ski/privacy/" target="_blank">éšç§æ”¿ç­–</a>
            </span>
          </label>

          <div id="register-error" class="text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg p-3 hidden">
            <div class="flex items-center">
              <span class="mr-2">âŒ</span>
              <span id="register-error-text"></span>
            </div>
          </div>

          <div id="register-success" class="text-sm text-green-600 bg-green-50 border border-green-200 rounded-lg p-3 hidden">
            <div class="flex items-center">
              <span class="mr-2">âœ…</span>
              <span>æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨ä¸ºæ‚¨è·³è½¬åˆ°ç™»å½•é¡µ...</span>
            </div>
          </div>

          <button
            id="register-btn"
            type="submit"
            class="w-full rounded-lg bg-blue-600 text-white px-4 py-2 text-sm font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all"
          >
            <span id="register-btn-text">æ³¨å†Œ</span>
            <span id="register-btn-loading" class="hidden">
              <svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              æ³¨å†Œä¸­...
            </span>
          </button>

          <div class="text-center text-sm text-gray-600 mt-4">
            å·²æœ‰è´¦å·ï¼Ÿ
            <a class="text-blue-600 hover:text-blue-800 hover:underline transition-colors" href="/ski/login/">ç«‹å³ç™»å½•</a>
          </div>
        </form>
      </div>
    </section>
  </main>

  <!-- ç»Ÿä¸€é¡µè„šï¼ˆå ä½ï¼‰ -->
  <div id="site-footer"></div>
  <script src="/ski/assets/footer.js"></script>
  <script>
    let isRegistering = false;
    let usernameCheckTimeout = null;

    function validateUsername() {
      const username = document.getElementById('username').value.trim();
      const usernameInput = document.getElementById('username');

      if (username.length < 3 || username.length > 20) {
        usernameInput.classList.add('border-red-500');
        usernameInput.classList.remove('border-gray-300');
        return false;
      } else {
        usernameInput.classList.remove('border-red-500');
        usernameInput.classList.add('border-gray-300');
        return true;
      }
    }

    function validateEmail() {
      const emailInput = document.getElementById('email');
      const emailError = document.getElementById('email-error');
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

      if (emailInput.value && !emailRegex.test(emailInput.value)) {
        emailError.classList.remove('hidden');
        emailInput.classList.add('border-red-500');
        emailInput.classList.remove('border-gray-300');
        return false;
      } else {
        emailError.classList.add('hidden');
        emailInput.classList.remove('border-red-500');
        emailInput.classList.add('border-gray-300');
        return true;
      }
    }

    function validatePassword() {
      const password = document.getElementById('pw').value;
      const passwordInput = document.getElementById('pw');

      // æ£€æŸ¥å„ä¸ªè¦æ±‚
      const hasLength = password.length >= 8;
      const hasLowercase = /[a-z]/.test(password);
      const hasUppercase = /[A-Z]/.test(password);
      const hasNumber = /\d/.test(password);

      // æ›´æ–°è¦æ±‚æŒ‡ç¤ºå™¨
      updateRequirement('req-length', hasLength);
      updateRequirement('req-lowercase', hasLowercase);
      updateRequirement('req-uppercase', hasUppercase);
      updateRequirement('req-number', hasNumber);

      // æ›´æ–°å¼ºåº¦æŒ‡ç¤ºå™¨
      const strength = [hasLength, hasLowercase, hasUppercase, hasNumber].filter(Boolean).length;
      updatePasswordStrength(strength);

      const isValid = hasLength && hasLowercase && hasUppercase && hasNumber;

      if (password && !isValid) {
        passwordInput.classList.add('border-red-500');
        passwordInput.classList.remove('border-gray-300');
      } else {
        passwordInput.classList.remove('border-red-500');
        passwordInput.classList.add('border-gray-300');
      }

      // è§¦å‘ç¡®è®¤å¯†ç éªŒè¯
      if (document.getElementById('pw2').value) {
        validatePasswordMatch();
      }

      return isValid;
    }

    function updateRequirement(elementId, isMet) {
      const element = document.getElementById(elementId);
      const icon = element.querySelector('span');

      if (isMet) {
        icon.textContent = 'âœ…';
        element.classList.remove('text-gray-500');
        element.classList.add('text-green-600');
      } else {
        icon.textContent = 'âŒ';
        element.classList.remove('text-green-600');
        element.classList.add('text-gray-500');
      }
    }

    function updatePasswordStrength(strength) {
      const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500'];

      for (let i = 1; i <= 4; i++) {
        const strengthBar = document.getElementById(`strength-${i}`);
        strengthBar.className = 'h-2 w-1/4 rounded';

        if (i <= strength) {
          strengthBar.classList.add(colors[strength - 1]);
        } else {
          strengthBar.classList.add('bg-gray-200');
        }
      }
    }

    function validatePasswordMatch() {
      const password = document.getElementById('pw').value;
      const confirmPassword = document.getElementById('pw2').value;
      const errorElement = document.getElementById('password-match-error');
      const successElement = document.getElementById('password-match-success');
      const confirmInput = document.getElementById('pw2');

      if (!confirmPassword) {
        errorElement.classList.add('hidden');
        successElement.classList.add('hidden');
        confirmInput.classList.remove('border-red-500', 'border-green-500');
        confirmInput.classList.add('border-gray-300');
        return true;
      }

      if (password !== confirmPassword) {
        errorElement.classList.remove('hidden');
        successElement.classList.add('hidden');
        confirmInput.classList.add('border-red-500');
        confirmInput.classList.remove('border-gray-300', 'border-green-500');
        return false;
      } else {
        errorElement.classList.add('hidden');
        successElement.classList.remove('hidden');
        confirmInput.classList.add('border-green-500');
        confirmInput.classList.remove('border-gray-300', 'border-red-500');
        return true;
      }
    }

    function togglePasswordVisibility(inputId, iconId) {
      const passwordInput = document.getElementById(inputId);
      const eyeIcon = document.getElementById(iconId);

      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.textContent = 'ğŸ™ˆ';
      } else {
        passwordInput.type = 'password';
        eyeIcon.textContent = 'ğŸ‘ï¸';
      }
    }

    function checkUsername() {
      const name = document.getElementById('username').value.trim();
      const loadingElement = document.getElementById('username-loading');
      const messageElement = document.getElementById('name-msg');
      const usernameInput = document.getElementById('username');

      if (!name) {
        messageElement.textContent = '';
        messageElement.className = 'text-sm mt-1';
        return;
      }

      if (name.length < 3) {
        messageElement.textContent = 'ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦';
        messageElement.className = 'text-sm mt-1 text-red-600';
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      loadingElement.classList.remove('hidden');
      messageElement.classList.add('hidden');

      // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
      if (usernameCheckTimeout) {
        clearTimeout(usernameCheckTimeout);
      }

      // æ¨¡æ‹ŸAPIæ£€æŸ¥
      usernameCheckTimeout = setTimeout(() => {
        loadingElement.classList.add('hidden');
        messageElement.classList.remove('hidden');

        if (['admin', 'test', 'guest', 'root', 'user'].includes(name.toLowerCase())) {
          messageElement.textContent = 'âŒ ç”¨æˆ·åå·²è¢«å ç”¨';
          messageElement.className = 'text-sm mt-1 text-red-600';
          usernameInput.classList.add('border-red-500');
          usernameInput.classList.remove('border-gray-300');
        } else {
          messageElement.textContent = 'âœ… ç”¨æˆ·åå¯ç”¨';
          messageElement.className = 'text-sm mt-1 text-green-600';
          usernameInput.classList.remove('border-red-500');
          usernameInput.classList.add('border-gray-300');
        }
      }, 800);
    }

    function showRegisterLoading() {
      const btnText = document.getElementById('register-btn-text');
      const btnLoading = document.getElementById('register-btn-loading');
      const registerBtn = document.getElementById('register-btn');

      btnText.classList.add('hidden');
      btnLoading.classList.remove('hidden');
      registerBtn.disabled = true;
    }

    function hideRegisterLoading() {
      const btnText = document.getElementById('register-btn-text');
      const btnLoading = document.getElementById('register-btn-loading');
      const registerBtn = document.getElementById('register-btn');

      btnText.classList.remove('hidden');
      btnLoading.classList.add('hidden');
      registerBtn.disabled = false;
    }

    function showRegisterError(message) {
      const errorDiv = document.getElementById('register-error');
      const errorText = document.getElementById('register-error-text');

      errorText.textContent = message;
      errorDiv.classList.remove('hidden');

      setTimeout(() => {
        errorDiv.classList.add('hidden');
      }, 5000);
    }

    function showRegisterSuccess() {
      const successDiv = document.getElementById('register-success');
      const errorDiv = document.getElementById('register-error');

      errorDiv.classList.add('hidden');
      successDiv.classList.remove('hidden');

      setTimeout(() => {
        window.location.href = '/ski/login/';
      }, 2000);
    }

    function handleRegister(e) {
      e.preventDefault();

      if (isRegistering) return false;

      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value;
      const password = document.getElementById('pw').value;
      const confirmPassword = document.getElementById('pw2').value;
      const agree = document.getElementById('agree').checked;

      // éªŒè¯æ‰€æœ‰å­—æ®µ
      const isUsernameValid = validateUsername();
      const isEmailValid = validateEmail();
      const isPasswordValid = validatePassword();
      const isPasswordMatchValid = validatePasswordMatch();

      if (!isUsernameValid) {
        showRegisterError('ç”¨æˆ·åæ ¼å¼ä¸æ­£ç¡®');
        return false;
      }

      if (!isEmailValid) {
        showRegisterError('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
        return false;
      }

      if (!isPasswordValid) {
        showRegisterError('å¯†ç ä¸ç¬¦åˆå®‰å…¨è¦æ±‚');
        return false;
      }

      if (!isPasswordMatchValid) {
        showRegisterError('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
        return false;
      }

      if (!agree) {
        showRegisterError('è¯·å…ˆåŒæ„æœåŠ¡æ¡æ¬¾ä¸éšç§æ”¿ç­–');
        return false;
      }

      // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦è¢«å ç”¨
      if (['admin', 'test', 'guest', 'root', 'user'].includes(username.toLowerCase())) {
        showRegisterError('è¯¥ç”¨æˆ·åå·²è¢«å ç”¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç”¨æˆ·å');
        return false;
      }

      isRegistering = true;
      showRegisterLoading();

      // æ¨¡æ‹Ÿæ³¨å†Œè¯·æ±‚
      setTimeout(() => {
        isRegistering = false;
        hideRegisterLoading();
        showRegisterSuccess();
      }, 2000);

      return false;
    }

    // é˜²æ­¢é‡å¤æäº¤
    document.getElementById('register-form').addEventListener('submit', function(e) {
      if (isRegistering) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>